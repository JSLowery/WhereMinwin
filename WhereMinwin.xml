<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Friday, November 04, 2016, 7:29 PM -->
<!-- MuClient version 4.98 -->

<!-- Plugin "WhereMinwin" generated by Plugin Wizard -->

<muclient>
<plugin
   name="WhereMinwin"
   author="Sonet"
   id="5fd2a99f8168d2fc74f144eb"
   language="Lua"
   purpose="Displays people in the area"
   save_state="y"
   date_written="2016-11-04 19:27:25"
   requires="4.40"
   version="1.0"
   >

</plugin>


<!--  Get our standard constants -->

<include name="constants.lua"/>

<!--  Triggers  -->

<triggers>
<trigger
   match="^Area created by : (.*)$"
   regexp="y"
   send_to="12"
   sequence="1"
   group="gag_where"
    omit_from_output="y"
  >
  </trigger>
  <trigger
   match="^Level range is  : (.*) to (.*)$"
   regexp="y"
   send_to="12"
   sequence="1"
   group="gag_where"
    omit_from_output="y"
  >
  </trigger>
  <trigger
   match="^You are in area\s+:\s+(.*)$"
   name="CurAreaminwin"
   regexp="y"
   send_to="12"
   sequence="1"
    omit_from_output="y"
   script="CurAreaminwin"
  >
  </trigger>
  <trigger
   match="^(?P<mob>[a-zA-Z]{3,30}) +(?P<room>.+)$"
   
   name="DoSomething"
   regexp="y"
   send_to="12"
   sequence="1"
   omit_from_output="y"
   script="whereGrabber"
  >
  </trigger>
  <trigger
   match="^(.*?)$"
   name="KillSomething"
   regexp="y"
   send_to="12"
   sequence="1"
   omit_from_output="y"
   script="stopGrabbing"
  >
  </trigger>
  <trigger
   match="^Players near you\:$"
   regexp="y"
   send_to="12"
   sequence="100"
   omit_from_output="y"
   script="whereStarter"
   name="whereStarter"
  >
  </trigger>
  <trigger
   match="{begin running}"
   send_to="12"
   enabled="y"
   sequence="1"
   omit_from_output="n"
   script="stallScript"
   name="begrun"
  >
  
  </trigger>
  <trigger
   match="{end running}"
   send_to="12"
   enabled="y"
   sequence="1"
   omit_from_output="n"
   script="allowScript"
   name="endrun"
  >
  
  </trigger>
</triggers>
<!--  Aliases  -->

<aliases>
  <alias
   name="where1"
   match="where1"
   enabled="y"
   send_to="12"
   sequence="100"
   script="startTheScript"
  >
  </alias>
</aliases>

<!--  Timers  -->

<timers>
  <timer name="bobtest" enabled="y" minute="0" second="30.00" offset_second="0.00"    send_to="12"
>
  <send>Execute('where1')</send>

  </timer>
</timers>

<!--  Script  -->


<script>
<![CDATA[
require "serialize"
require "tprint"
whereTable = {}
count = 1
local curArea= ""
local stall = false
function stallScript()
  stall = true
end
function allowScript()
  stall = false
  do_Execute_no_echo('where1')
end
function CurAreaminwin(name, line, wildcards)
  curArea = wildcards[1]
end
function whereGrabber(name,line,wildcards)
    -- print ("whereGrabber")
    -- print(wildcards[1])
    -- print(wildcards[2])
    whereTable[count] = {wildcards[1], wildcards[2]}
    DoAfterSpecial(.1 ,'stopGrabbing()', 12)
    count = count +1
end
function stopGrabbing(name,line,wildcards)
  -- print ("stopGrabbing")
    --print(wildcards[1])
    --tprint (whereTable)
    EnableTrigger("DoSomething", 0)
    EnableTrigger("KillSomething", 0)
    EnableTrigger("whereStarter", 0)
    EnableTrigger("CurAreaminwin", 0)
    EnableTriggerGroup("gag_where", 0)
    show_whwin()
end
function whereStarter()
  -- print ("whereStarter")
  EnableTrigger("DoSomething", 1)
end
function startTheScript()
  if stall then return end
  -- print("sending where")
  whereTable = {}
  count = 1

  do_Execute_no_echo('where')
  EnableTrigger("whereStarter", 1)
  EnableTrigger("CurAreaminwin", 1)
  EnableTriggerGroup("gag_where", 1)
end
function do_Execute_no_echo(command)
  local original_echo_setting = GetOption("display_my_input")
  SetOption("display_my_input", 0)
  Execute(command)
  SetOption("display_my_input", original_echo_setting)
end
dofile (GetPluginInfo (GetPluginID (), 20) .. "luapath.lua")

require 'var'
require "commas"
require 'miniwin'
require 'tprint'
require 'pluginhelper'
require 'ldplugin'
require 'aardutils'
require 'verify'

whwin = Miniwin:new{name="Where Saver"}
whwin:set_default('windowpos', 7)
whwin:add_setting("time_colour", {help="the colour for the time", type="colour", default=verify_colour(0xD670DA), sortlev=1})
whwin:add_setting("mobdead_colour", {help="the colour for when a mob is dead", type="colour", default=verify_colour("red"), sortlev=1})
whwin:add_setting("mobnotfound", {help="the colour for when a mob is not in kill table db", type="colour", default=verify_colour("green"), sortlev=1})
whwin:add_setting("notlevel_colour", {help="the colour for when this cp is no longer from this level", type="colour", default=verify_colour("cyan"), sortlev=1})
--whwin:disable()

cpmobs = {}
cptimer = {}
level = nil
curlevel = nil
showwhwin = false

function set_show()
  showwhwin = true
end

function show_whwin ()

  local texttable = {}
  local header = {}
  local style = {}

  style = {}
  style.text = string.format("Area: %s", curArea)
  table.insert (header, {style})

  -- list of mobs
  for i, v in ipairs (whereTable) do
    style = {}

      style.text = string.format("%-30s   %s", v[1],   v[2])
 
      style.textcolour = "time_colour"
    if v[2] == "???" then
      style.textcolour = "mobdead_colour"
    end
    table.insert (texttable, {style})
  --   --tprint (texttable)
  end -- for

 

  whwin:enable()
  whwin:addtab('default', texttable, header, true)
  
    whwin:show(true)
   
  
  --whwin:changetotab('default')

  style = {}
  style.text = " Area: " .. curArea
  whwin:tabbroadcast(true, {style})

end 
local curZone
local lastZone
function OnPluginBroadcast (msg, id, name, text)
  local runningFlag= 3
    if (text== "char.status") then
      res, gmcparg = CallPlugin("3e7dedbe37e44942dd46d264","gmcpval","char.status")
        luastmt = "gmcpdata = " .. gmcparg
        assert (loadstring (luastmt or "")) ()
        runningFlag = gmcpdata.state
    end

    if (text == "room.info") then
        res, gmcparg = CallPlugin("3e7dedbe37e44942dd46d264","gmcpval","room.info")
        luastmt = "gmcpdata = " .. gmcparg
        assert (loadstring (luastmt or "")) ()
        curZone = gmcpdata.zone
        if runningFlag ~= 3 or stall then return end
        if lastZone == nil then lastZone= curZone end
        if lastZone ~= curZone and not stall then
         -- print (lastZone)
         -- print (curArea)
          lastZone = curZone
          do_Execute_no_echo("where1")
        end

    end
end



function OnPluginInstall ()
  --OnPluginEnable is automatically called by pluginhelper

  phelper:OnPluginInstall()
end -- OnPluginInstall

function OnPluginClose()

  phelper:OnPluginClose()
end -- OnPluginClose

function OnPluginEnable ()
 

  phelper:OnPluginEnable()
 
end -- OnPluginEnable

function OnPluginDisable ()

  phelper:OnPluginDisable()
end -- OnPluginDisable

function OnPluginConnect ()

  phelper:OnPluginConnect()
end -- OnPluginConnect

function OnPluginDisconnect ()

  phelper:OnPluginDisconnect()
end -- function OnPluginConnect

function OnPluginSaveState ()

  phelper:OnPluginSaveState()
end -- function OnPluginSaveState
phelper:set_default('cmd', 'mcp')
phelper:set_default('plugin_colour', 'steelblue')

phelper:add_pobject('win', whwin)

phelper:enable()
]]>
</script>



</muclient>
